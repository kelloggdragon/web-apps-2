<%# Casino Dice - High End Experience %>
<div class="casino-stage">
  <div class="casino-table">
    <div class="table-felt">
      <div class="logo-overlay">
        <h1>ROYAL<br>GEMINI</h1>
        <p>EST. 2026</p>
      </div>

      <div class="dice-arena-3d">
        <div class="dice-platform">
          <div class="die-3d" id="die-1">
            <div class="face front"></div>
            <div class="face back"></div>
            <div class="face right"></div>
            <div class="face left"></div>
            <div class="face top"></div>
            <div class="face bottom"></div>
          </div>
          <div class="die-3d" id="die-2">
            <div class="face front"></div>
            <div class="face back"></div>
            <div class="face right"></div>
            <div class="face left"></div>
            <div class="face top"></div>
            <div class="face bottom"></div>
          </div>
        </div>
      </div>

      <div class="betting-zones">
        <div class="zone" data-bet="under">
          <span class="payout">1:1</span>
          UNDER 7
          <div class="chip-stack"></div>
        </div>
        <div class="zone" data-bet="seven">
          <span class="payout">4:1</span>
          EXACT 7
          <div class="chip-stack"></div>
        </div>
        <div class="zone" data-bet="over">
          <span class="payout">1:1</span>
          OVER 7
          <div class="chip-stack"></div>
        </div>
      </div>
    </div>

    <div class="rail-hud">
      <div class="stat-box">
        <label>BALANCE</label>
        <div class="value" id="balance-display">$1,000</div>
      </div>
      
      <div class="chip-selector">
        <button class="chip chip-5" data-val="5">$5</button>
        <button class="chip chip-25" data-val="25">$25</button>
        <button class="chip chip-100" data-val="100">$100</button>
        <button class="chip chip-500" data-val="500">$500</button>
      </div>

      <div class="actions">
        <button id="clear-btn" class="btn-secondary">CLEAR</button>
        <button id="roll-btn" class="btn-primary" disabled>ROLL DICE</button>
      </div>
    </div>
  </div>
  
  <div id="result-overlay" class="hidden">
    <div class="content">
      <h2 id="result-title">WINNER</h2>
      <p id="result-amount">+$200</p>
    </div>
  </div>
  <canvas id="fx-canvas"></canvas>
</div>

<style>
  /* Import fonts for that luxury feel */
  @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Lato:wght@300;400;700&display=swap');

  :root {
    --felt-green: #0e3b1c;
    --felt-dark: #05160a;
    --gold-main: #d4af37;
    --gold-light: #f3e5ab;
    --gold-shadow: #8a7024;
    --chip-red: #d32f2f;
    --chip-blue: #1976d2;
    --chip-black: #212121;
    --chip-purple: #7b1fa2;
  }

  body {
    background: #050505;
    margin: 0;
    overflow: hidden;
    font-family: 'Lato', sans-serif;
    cursor: default !important;
  }
  
  #custom-cursor, #cursor-blur {
    display: none !important;
  }
  
  #fx-canvas {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    z-index: 50;
  }

  .casino-stage {
    width: 100vw;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
  }

  .casino-table {
    width: 90%;
    max-width: 1200px;
    height: 80vh;
    background: radial-gradient(circle at center, var(--felt-green) 0%, var(--felt-dark) 85%);
    border-radius: 200px;
    border: 15px solid #2a2a2a;
    box-shadow: 
      inset 0 0 100px #000,
      0 0 0 5px var(--gold-shadow),
      0 20px 50px rgba(0,0,0,0.8);
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    overflow: hidden;
  }

  /* Table Decor */
  .logo-overlay {
    position: absolute;
    top: 15%;
    left: 50%;
    transform: translateX(-50%);
    text-align: center;
    opacity: 0.3;
    pointer-events: none;
    color: var(--gold-main);
  }
  .logo-overlay h1 {
    font-family: 'Cinzel', serif;
    font-size: 3rem;
    margin: 0;
    letter-spacing: 0.2em;
    line-height: 1;
  }
  .logo-overlay p {
    font-size: 0.9rem;
    letter-spacing: 0.5em;
    margin-top: 10px;
  }

  /* Dice Arena */
  .dice-arena-3d {
    flex-grow: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    perspective: 1000px;
    z-index: 10;
  }
  .dice-platform {
    display: flex;
    gap: 50px;
    transform-style: preserve-3d;
  }

  .die-3d {
    width: 80px;
    height: 80px;
    position: relative;
    transform-style: preserve-3d;
    transform: rotateX(-20deg) rotateY(30deg);
    transition: transform 0.1s; /* JS will handle fast updates */
  }

  .face {
    position: absolute;
    width: 80px;
    height: 80px;
    background: #fff;
    border-radius: 12px;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
    border: 1px solid #ddd;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 0; /* Hide default text if any */
    backface-visibility: hidden;
  }
  /* Construct the cube */
  .face.front  { transform: rotateY(0deg) translateZ(40px); }
  .face.back   { transform: rotateY(180deg) translateZ(40px); }
  .face.right  { transform: rotateY(90deg) translateZ(40px); }
  .face.left   { transform: rotateY(-90deg) translateZ(40px); }
  .face.top    { transform: rotateX(90deg) translateZ(40px); }
  .face.bottom { transform: rotateX(-90deg) translateZ(40px); }

  /* Map dice textures */
  .die-3d .face {
    background-size: cover;
    background-position: center;
  }
  /* Preload logic handled in JS, but here are defaults */
  .die-3d .face { background-image: url('/images/dice/1.svg'); }
  .die-3d .face:nth-child(1) { background-image: url('/images/dice/1.svg'); }
  .die-3d .face:nth-child(2) { background-image: url('/images/dice/6.svg'); }
  .die-3d .face:nth-child(3) { background-image: url('/images/dice/3.svg'); }
  .die-3d .face:nth-child(4) { background-image: url('/images/dice/4.svg'); }
  .die-3d .face:nth-child(5) { background-image: url('/images/dice/5.svg'); }
  .die-3d .face:nth-child(6) { background-image: url('/images/dice/2.svg'); }

  /* Betting Zones */
  .betting-zones {
    display: flex;
    justify-content: center;
    gap: 2rem;
    padding-bottom: 2rem;
    z-index: 5;
  }

  .zone {
    width: 180px;
    height: 120px;
    border: 2px solid rgba(212, 175, 55, 0.3);
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: rgba(255,255,255,0.7);
    font-family: 'Cinzel', serif;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    background: rgba(0,0,0,0.2);
  }

  .zone:hover {
    background: rgba(212, 175, 55, 0.1);
    border-color: rgba(212, 175, 55, 0.8);
    transform: translateY(-5px);
  }

  .zone.active {
    background: rgba(212, 175, 55, 0.2);
    border-color: var(--gold-main);
    box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
  }

  .zone .payout {
    font-size: 0.7rem;
    margin-bottom: 5px;
    color: var(--gold-main);
  }

  .zone .chip-stack {
    position: absolute;
    bottom: 50%;
    left: 50%;
    transform: translate(-50%, 50%);
    pointer-events: none;
  }
  
  /* Rendered Chips in zones */
  .bet-chip {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 3px dashed #fff;
    box-shadow: 0 3px 5px rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: bold;
    color: #fff;
    font-size: 10px;
    position: absolute;
    transition: transform 0.2s;
  }

  /* HUD Rail */
  .rail-hud {
    background: #1a1a1a;
    height: 120px;
    border-top: 5px solid #2a2a2a;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 3rem;
    box-shadow: 0 -10px 30px rgba(0,0,0,0.5);
    z-index: 20;
  }

  .stat-box {
    text-align: center;
  }
  .stat-box label {
    display: block;
    color: #666;
    font-size: 0.7rem;
    letter-spacing: 0.2em;
    margin-bottom: 5px;
  }
  .stat-box .value {
    color: var(--gold-main);
    font-size: 1.8rem;
    font-family: 'Cinzel', serif;
  }

  .chip-selector {
    display: flex;
    gap: 1rem;
    background: #000;
    padding: 10px 20px;
    border-radius: 50px;
    border: 1px solid #333;
  }

  .chip {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: 4px dashed rgba(255,255,255,0.3);
    cursor: pointer;
    font-weight: bold;
    font-family: 'Cinzel', serif;
    color: #fff;
    text-shadow: 0 1px 2px rgba(0,0,0,0.8);
    transition: transform 0.2s, box-shadow 0.2s;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .chip:hover { transform: scale(1.1); }
  .chip.selected {
    transform: scale(1.15) translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.5);
    border-color: #fff;
  }
  .chip::after {
    content: '';
    position: absolute;
    top: 5px; left: 5px; right: 5px; bottom: 5px;
    border-radius: 50%;
    border: 1px solid rgba(255,255,255,0.2);
  }

  .chip-5 { background: var(--chip-red); }
  .chip-25 { background: var(--chip-blue); }
  .chip-100 { background: var(--chip-black); }
  .chip-500 { background: var(--chip-purple); }

  .actions {
    display: flex;
    gap: 1rem;
  }

  .btn-primary, .btn-secondary {
    padding: 1rem 2.5rem;
    font-family: 'Cinzel', serif;
    font-weight: 900;
    letter-spacing: 0.1em;
    cursor: pointer;
    text-transform: uppercase;
    transition: all 0.3s;
    border: none;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--gold-main), var(--gold-shadow));
    color: #000;
    border-radius: 4px;
    box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3);
  }
  .btn-primary:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(212, 175, 55, 0.5);
  }
  .btn-primary:disabled {
    filter: grayscale(1);
    opacity: 0.5;
    cursor: not-allowed;
  }

  .btn-secondary {
    background: transparent;
    color: #666;
    border: 1px solid #444;
    border-radius: 4px;
  }
  .btn-secondary:hover {
    color: #fff;
    border-color: #fff;
  }

  /* Result Overlay */
  #result-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    background: rgba(0,0,0,0.7);
    z-index: 100;
    backdrop-filter: blur(5px);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s;
  }
  #result-overlay.visible {
    opacity: 1;
    pointer-events: auto;
  }
  #result-overlay .content {
    text-align: center;
    transform: scale(0.8);
    transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  #result-overlay.visible .content {
    transform: scale(1);
  }
  #result-title {
    font-family: 'Cinzel', serif;
    font-size: 4rem;
    color: var(--gold-main);
    margin: 0;
    text-transform: uppercase;
    text-shadow: 0 0 20px var(--gold-shadow);
  }
  #result-amount {
    font-size: 2rem;
    color: #fff;
    margin-top: 10px;
  }

</style>

<script>
  // Game State
  const state = {
    balance: 1000,
    currentBet: 0,
    selectedChip: 25,
    bets: {
      under: 0,
      seven: 0,
      over: 0
    },
    isRolling: false
  };

  // DOM Elements
  const ui = {
    balance: document.getElementById('balance-display'),
    chips: document.querySelectorAll('.chip'),
    zones: document.querySelectorAll('.zone'),
    rollBtn: document.getElementById('roll-btn'),
    clearBtn: document.getElementById('clear-btn'),
    die1: document.getElementById('die-1'),
    die2: document.getElementById('die-2'),
    overlay: document.getElementById('result-overlay'),
    resTitle: document.getElementById('result-title'),
    resAmt: document.getElementById('result-amount'),
    audioRoll: document.getElementById('sound-roll'),
    audioClick: document.getElementById('sound-click')
  };

  // Audio Synth for "Win" (Simple Web Audio)
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  
  function resumeAudio() {
    if (audioCtx.state === 'suspended') {
      audioCtx.resume();
    }
  }

  function playWinSound() {
    resumeAudio();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    
    osc.type = 'triangle';
    osc.frequency.setValueAtTime(440, audioCtx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.1);
    osc.frequency.exponentialRampToValueAtTime(1760, audioCtx.currentTime + 0.3);
    
    gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.6);
    
    osc.start();
    osc.stop(audioCtx.currentTime + 0.6);
  }

  // FX System
  const canvas = document.getElementById('fx-canvas');
  const ctx = canvas.getContext('2d');
  let particles = [];

  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  class Particle {
    constructor(x, y) {
      this.x = x;
      this.y = y;
      this.angle = Math.random() * Math.PI * 2;
      this.speed = Math.random() * 10 + 5;
      this.life = 100;
      this.color = `hsl(${Math.random() * 60 + 30}, 100%, 50%)`; // Gold/Yellow spectrum
    }
    update() {
      this.x += Math.cos(this.angle) * this.speed;
      this.y += Math.sin(this.angle) * this.speed;
      this.life -= 2;
      this.speed *= 0.95;
    }
    draw() {
      ctx.globalAlpha = this.life / 100;
      ctx.fillStyle = this.color;
      ctx.beginPath();
      ctx.arc(this.x, this.y, 4, 0, Math.PI * 2);
      ctx.fill();
    }
  }

  function triggerExplosion() {
    const cx = window.innerWidth / 2;
    const cy = window.innerHeight / 2;
    for(let i=0; i<100; i++) {
      particles.push(new Particle(cx, cy));
    }
    animateParticles();
  }

  function animateParticles() {
    if(particles.length === 0) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        return;
    }
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    for (let i = particles.length - 1; i >= 0; i--) {
      const p = particles[i];
      p.update();
      p.draw();
      if (p.life <= 0) {
        particles.splice(i, 1);
      }
    }
    
    requestAnimationFrame(animateParticles);
  }

  // Initialization
  function init() {
    updateBalance(0);
    setupInteractions();
    
    // Select default chip
    selectChip(25);
  }

  function setupInteractions() {
    document.body.addEventListener('click', resumeAudio, { once: true });

    // Chip Selection
    ui.chips.forEach(chip => {
      chip.addEventListener('click', () => selectChip(parseInt(chip.dataset.val)));
    });

    // Placing Bets
    ui.zones.forEach(zone => {
      zone.addEventListener('click', () => placeBet(zone.dataset.bet));
    });

    // Controls
    ui.clearBtn.addEventListener('click', clearBets);
    ui.rollBtn.addEventListener('click', rollDice);
    
    ui.overlay.addEventListener('click', () => {
      ui.overlay.classList.remove('visible');
    });
  }

  function selectChip(val) {
    state.selectedChip = val;
    ui.chips.forEach(c => c.classList.remove('selected'));
    document.querySelector(`.chip-${val}`).classList.add('selected');
    playClick();
  }

  function placeBet(type) {
    if (state.isRolling) return;
    if (state.balance < state.selectedChip) {
      alert("Insufficient funds!");
      return;
    }

    // Logic
    state.balance -= state.selectedChip;
    state.bets[type] += state.selectedChip;
    state.currentBet += state.selectedChip;

    // UI
    updateBalance(0);
    renderChips(type);
    ui.rollBtn.disabled = false;
    playClick();
  }

  function clearBets() {
    if (state.isRolling) return;
    
    // Refund
    state.balance += state.currentBet;
    
    // Reset
    state.bets = { under: 0, seven: 0, over: 0 };
    state.currentBet = 0;
    
    // UI
    updateBalance(0);
    document.querySelectorAll('.chip-stack').forEach(el => el.innerHTML = '');
    ui.rollBtn.disabled = true;
    playClick();
  }

  function renderChips(type) {
    const zone = document.querySelector(`.zone[data-bet="${type}"]`);
    const stack = zone.querySelector('.chip-stack');
    
    // Add visual chip
    const chip = document.createElement('div');
    chip.classList.add('bet-chip');
    
    // Determine color
    let color = '#212121';
    if(state.selectedChip === 5) color = 'var(--chip-red)';
    if(state.selectedChip === 25) color = 'var(--chip-blue)';
    if(state.selectedChip === 500) color = 'var(--chip-purple)';
    
    chip.style.backgroundColor = color;
    chip.innerText = state.selectedChip;
    
    // Random offset for natural stacking look
    const randX = (Math.random() - 0.5) * 10;
    const randY = (Math.random() - 0.5) * 10;
    chip.style.transform = `translate(${randX}px, ${randY}px)`;
    
    // Stack logic (visual only, simplified)
    stack.appendChild(chip);
    
    // Limit stack height visually
    if(stack.children.length > 10) {
       stack.removeChild(stack.firstChild);
    }
  }

  function updateBalance(change) {
    state.balance += change;
    ui.balance.innerText = "$" + state.balance.toLocaleString();
  }

  function playClick() {
    ui.audioClick.currentTime = 0;
    ui.audioClick.play().catch(e => {});
  }

  async function rollDice() {
    if(state.isRolling) return;
    state.isRolling = true;
    ui.rollBtn.disabled = true;
    ui.clearBtn.disabled = true;
    
    ui.audioRoll.currentTime = 0;
    ui.audioRoll.play().catch(e => {});

    // Animation Phase
    const duration = 2000; // 2 seconds roll
    const startTime = Date.now();
    
    const animInterval = setInterval(() => {
        // Random rotation for chaos
        const x = Math.random() * 720 - 360;
        const y = Math.random() * 720 - 360;
        const z = Math.random() * 720 - 360;
        
        ui.die1.style.transform = `rotateX(${x}deg) rotateY(${y}deg) rotateZ(${z}deg)`;
        ui.die2.style.transform = `rotateX(${y}deg) rotateY(${z}deg) rotateZ(${x}deg)`; // slightly diff
    }, 50);

    // Fetch Result from Server
    try {
      const response = await fetch('/dice.json');
      const data = await response.json();
      
      setTimeout(() => {
        clearInterval(animInterval);
        resolveRoll(data.die1, data.die2, data.total);
      }, duration);
      
    } catch(e) {
      console.error(e);
      state.isRolling = false; // reset on error
    }
  }

  function resolveRoll(d1, d2, total) {
    // Stop rotation at specific face
    // We need to map Face Value to Rotation Angles
    // Default Cube: 1 is Front.
    // 1: rotateY(0)
    // 2: rotateY(180)?? No, 6 is back.
    // Let's map based on our CSS construction:
    // Front: 1, Back: 6 (Standard dice are opposite adds to 7)
    // But our CSS texture mapping might be different.
    // Let's re-verify CSS construction.
    // .die-3d .face:nth-child(1) -> 1
    // .die-3d .face:nth-child(2) -> 6
    // .die-3d .face:nth-child(3) -> 3
    // .die-3d .face:nth-child(4) -> 4
    // .die-3d .face:nth-child(5) -> 5
    // .die-3d .face:nth-child(6) -> 2
    
    // Face | Transform to show it (inverse of face transform)
    // 1 (Front) -> rotateY(0) rotateX(0)
    // 6 (Back)  -> rotateY(180)
    // 3 (Right) -> rotateY(-90)
    // 4 (Left)  -> rotateY(90)
    // 5 (Top)   -> rotateX(-90)
    // 2 (Bottom)-> rotateX(90)
    
    const rotations = {
      1: {x: 0, y: 0},
      6: {x: 0, y: 180},
      3: {x: 0, y: -90},
      4: {x: 0, y: 90},
      5: {x: -90, y: 0},
      2: {x: 90, y: 0}
    };
    
    // Apply final rotation
    // Add multiple of 360 for extra spin effect
    const spin = 1080; 
    
    setFace(ui.die1, d1, rotations, spin);
    setFace(ui.die2, d2, rotations, spin);
    
    setTimeout(() => {
      calculateWinnings(total);
      state.isRolling = false;
      ui.clearBtn.disabled = false;
    }, 1000); // Wait for transition
  }
  
  function setFace(el, val, map, spin) {
    const target = map[val];
    // We need to match the mapping to the actual BG images
    // My CSS map: 1=1, 2=6, 3=3, 4=4, 5=5, 6=2
    // So if server sends "2", we want to show face #6 (which has image 2).
    // Wait, let's fix the CSS mapping to be standard or just map correctly here.
    // CSS:
    // child(1): img 1 -> Face Front
    // child(2): img 6 -> Face Back
    // child(3): img 3 -> Face Right
    // child(4): img 4 -> Face Left
    // child(5): img 5 -> Face Top
    // child(6): img 2 -> Face Bottom
    
    // So if val is 1 -> show Front
    // If val is 6 -> show Back
    // If val is 3 -> show Right
    // If val is 4 -> show Left
    // If val is 5 -> show Top
    // If val is 2 -> show Bottom
    
    el.style.transition = "transform 0.8s cubic-bezier(0.25, 1, 0.5, 1)";
    el.style.transform = `rotateX(${target.x + spin}deg) rotateY(${target.y + spin}deg)`;
  }

  function calculateWinnings(total) {
    let winnings = 0;
    
    // Rules
    // Under 7
    if (total < 7 && state.bets.under > 0) {
      winnings += state.bets.under * 2; // Return bet + 1:1
    }
    // Over 7
    if (total > 7 && state.bets.over > 0) {
      winnings += state.bets.over * 2;
    }
    // Exact 7
    if (total === 7 && state.bets.seven > 0) {
      winnings += state.bets.seven * 5; // Return bet + 4:1
    }
    
    if (winnings > 0) {
      showResult("WINNER", `+$${winnings}`);
      playWinSound();
      updateBalance(winnings);
      triggerExplosion();
    } else {
      if(state.currentBet > 0) {
         showResult("HOUSE WINS", "-$" + state.currentBet);
      }
    }
    
    // Reset Round logic partially?
    // In casinos, bets usually stay or are cleared. 
    // Let's clear bets for simple flow
    state.bets = { under: 0, seven: 0, over: 0 };
    state.currentBet = 0;
    document.querySelectorAll('.chip-stack').forEach(el => el.innerHTML = '');
    ui.rollBtn.disabled = true;
  }

  function showResult(title, sub) {
    ui.resTitle.innerText = title;
    ui.resAmt.innerText = sub;
    ui.resTitle.style.color = title === "WINNER" ? "var(--gold-main)" : "#666";
    
    ui.overlay.classList.add('visible');
    
    // Auto hide after 2s
    setTimeout(() => {
      ui.overlay.classList.remove('visible');
    }, 3000);
  }

  // Run
  document.addEventListener('DOMContentLoaded', init);

</script>
